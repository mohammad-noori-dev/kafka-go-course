services:
  kafka:
    image: apache/kafka:latest # Apache Kafka latest Docker image
    hostname: kafka
    container_name: kafka-broker

    ports:
      - "9092:9092" # External listener for clients
      - "9093:9093" # Internal listener for KRaft controller communication

    environment:
      # --- KRaft Configuration for Apache Kafka 4.0 ---
      KAFKA_PROCESS_ROLES: "broker,controller" # Combined broker + controller
      KAFKA_NODE_ID: 1
      KAFKA_BROKER_ID: 1

      # Crucial: The Cluster ID must be passed to the running Kafka process
      CLUSTER_ID: "x_U1am78TmmyI8NZNRQboA" # USE YOUR ACTUAL CLUSTER ID

      # KRaft controller quorum (single node)
      # Format: <node-id>@<hostname>:<controller-port>
      KAFKA_CONTROLLER_QUORUM_VOTERS: "1@kafka:9093"

      # Listeners (inside container)
      KAFKA_LISTENERS: "CLIENT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093"

      # Advertised listeners (how clients connect)
      KAFKA_ADVERTISED_LISTENERS: "CLIENT://localhost:9092,CONTROLLER://kafka:9093"

      # Listener security mapping
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: "CLIENT:PLAINTEXT,CONTROLLER:PLAINTEXT"
      KAFKA_CONTROLLER_LISTENER_NAMES: "CONTROLLER"

      # Inter-broker communication
      KAFKA_INTER_BROKER_LISTENER_NAME: "CLIENT"

      # Paths for logs and KRaft metadata
      KAFKA_LOG_DIRS: "/tmp/kraft-data"

      # --- Other Standard Kafka Configurations ---
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_NUM_PARTITIONS: 3

    volumes:
      - ./kafka-data:/tmp/kraft-data # Persist Kafka data on host

    networks:
      - kafka-net

# Network definition
networks:
  kafka-net:
    driver: bridge

# Persistent volume definition
volumes:
  kafka-data:
    driver: local
